<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All to PDF Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .hero-section { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 60px 0; margin-bottom: 40px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .nav-pills .nav-link { border-radius: 10px; padding: 12px 25px; font-weight: 500; color: #495057; }
        .nav-pills .nav-link.active { background-color: #007bff; box-shadow: 0 4px 12px rgba(0,123,255,0.3); }
        .btn-primary { border-radius: 10px; padding: 12px 30px; font-weight: 600; background-color: #007bff; border: none; }
        .btn-primary:hover { background-color: #0069d9; }
        .drop-zone { border: 2px dashed #dee2e6; border-radius: 15px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; background: #fff; }
        .drop-zone:hover, .drop-zone.active { border-color: #007bff; background: #f0f7ff; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3">ƒêang chuy·ªÉn ƒë·ªïi... Vui l√≤ng ƒë·ª£i</h5>
    <p class="text-muted">Vi·ªác n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y t√πy v√†o k√≠ch th∆∞·ªõc file ho·∫∑c trang web.</p>
</div>

<div class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 fw-bold mb-3"><i class="fas fa-file-pdf me-3"></i>All to PDF</h1>
        <p class="lead mb-0">Chuy·ªÉn ƒë·ªïi Website, H√¨nh ·∫£nh v√† T√†i li·ªáu Office sang PDF ch·∫•t l∆∞·ª£ng cao.</p>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <ul class="nav nav-pills mb-4 justify-content-center" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-url-tab" data-bs-toggle="pill" data-bs-target="#pills-url" type="button" role="tab"><i class="fas fa-globe me-2"></i>Website to PDF</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link ms-3" id="pills-file-tab" data-bs-toggle="pill" data-bs-target="#pills-file" type="button" role="tab"><i class="fas fa-file-upload me-2"></i>File to PDF</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link ms-3" id="pills-extract-tab" data-bs-toggle="pill" data-bs-target="#pills-extract" type="button" role="tab"><i class="fas fa-file-export me-2"></i>Extract from PDF</button>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <!-- URL to PDF -->
                <div class="tab-pane fade show active" id="pills-url" role="tabpanel">
                    <div class="card p-4">
                        <form id="urlForm">
                            <div class="mb-4">
                                <label class="form-label fw-bold">Nh·∫≠p ƒë·ªãa ch·ªâ Website (URL)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-link text-muted"></i></span>
                                    <input type="url" class="form-control form-control-lg" name="url" placeholder="https://example.com" required>
                                </div>
                                <div class="form-text mt-2">H·ªó tr·ª£ t·ª± ƒë·ªông cu·ªôn trang ƒë·ªÉ t·∫£i ƒë·∫ßy ƒë·ªß h√¨nh ·∫£nh (Lazy Loading).</div>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-magic me-2"></i>B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- File to PDF -->
                <div class="tab-pane fade" id="pills-file" role="tabpanel">
                    <div class="card p-4">
                        <form id="fileForm">
                            <div class="mb-4">
                                <label class="form-label fw-bold">Ch·ªçn t√†i li·ªáu ho·∫∑c h√¨nh ·∫£nh</label>
                                <div class="drop-zone" id="dropZone">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <h5>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h5>
                                    <p class="text-muted mb-0">H·ªó tr·ª£: .docx, .xlsx, .pptx, .jpg, .png, .webp...</p>
                                    <input type="file" id="fileInput" name="file" class="d-none" required>
                                </div>
                                <div id="fileInfo" class="mt-3 text-center d-none">
                                    <span class="badge bg-info p-2"><i class="fas fa-file me-2"></i><span id="fileName"></span></span>
                                </div>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-magic me-2"></i>B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Extract from PDF -->
                <div class="tab-pane fade" id="pills-extract" role="tabpanel">
                    <div class="card p-4">
                        <form id="extractForm">
                            <div class="mb-4">
                                <label class="form-label fw-bold">Ch·ªçn file PDF ƒë·ªÉ tr√≠ch xu·∫•t n·ªôi dung</label>
                                <div class="drop-zone" id="dropZoneExtract">
                                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                    <h5>K√©o th·∫£ file PDF v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</h5>
                                    <p class="text-muted mb-2">T·ª± ƒë·ªông tr√≠ch xu·∫•t:</p>
                                    <div class="d-flex justify-content-center gap-3 mb-0">
                                        <span class="badge bg-success"><i class="fas fa-file-alt me-1"></i>Text</span>
                                        <span class="badge bg-warning text-dark"><i class="fas fa-table me-1"></i>Tables</span>
                                        <span class="badge bg-info"><i class="fas fa-image me-1"></i>Images</span>
                                    </div>
                                    <input type="file" id="extractInput" name="file" accept=".pdf" class="d-none" required>
                                </div>
                                <div id="extractFileInfo" class="mt-3 text-center d-none">
                                    <span class="badge bg-danger p-2"><i class="fas fa-file-pdf me-2"></i><span id="extractFileName"></span></span>
                                </div>
                            </div>
                            
                            <!-- Method Selection -->
                            <div class="mb-4">
                                <label class="form-label fw-bold"><i class="fas fa-cog me-2"></i>Ph∆∞∆°ng ph√°p tr√≠ch xu·∫•t</label>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-check-inline p-3 border rounded w-100">
                                            <input class="form-check-input" type="radio" name="extractMethod" id="methodDocling" value="docling" checked>
                                            <label class="form-check-label w-100" for="methodDocling">
                                                <strong>Docling</strong> <span class="badge bg-primary">M·∫∑c ƒë·ªãnh</span>
                                                <small class="d-block text-muted">Nhanh, ch√≠nh x√°c, h·ªó tr·ª£ t·ªët b·∫£ng ph·ª©c t·∫°p</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-check-inline p-3 border rounded w-100">
                                            <input class="form-check-input" type="radio" name="extractMethod" id="methodUnstructured" value="unstructured">
                                            <label class="form-check-label w-100" for="methodUnstructured">
                                                <strong>Unstructured</strong> <span class="badge bg-secondary">AI Model</span>
                                                <small class="d-block text-muted mt-1">
                                                    YOLOX AI, HTML tables
                                                    <br>
                                                    <span class="text-warning">üí° Install Tesseract for best results</span>
                                                </small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="button" id="viewExtractBtn" class="btn btn-primary btn-lg me-2">
                                    <i class="fas fa-eye me-2"></i>Xem k·∫øt qu·∫£ tr·ª±c ti·∫øp
                                </button>
                                <button type="button" id="downloadExtractBtn" class="btn btn-outline-primary btn-lg">
                                    <i class="fas fa-download me-2"></i>T·∫£i v·ªÅ ZIP
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="mt-5 text-center text-muted">
                <p><small>&copy; 2026  PDF Converter. ƒê∆∞·ª£c t·ªëi ∆∞u b·ªüi Playwright & LibreOffice.</small></p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const loading = document.getElementById('loadingOverlay');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    
    // Extract form elements
    const dropZoneExtract = document.getElementById('dropZoneExtract');
    const extractInput = document.getElementById('extractInput');
    const extractFileInfo = document.getElementById('extractFileInfo');
    const extractFileName = document.getElementById('extractFileName');

    // Handle Drop Zone for File to PDF
    dropZone.onclick = () => fileInput.click();
    
    fileInput.onchange = (e) => {
        if (e.target.files.length > 0) {
            fileName.innerText = e.target.files[0].name;
            fileInfo.classList.remove('d-none');
        }
    };

    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('active'); };
    dropZone.ondragleave = () => { dropZone.classList.remove('active'); };
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileName.innerText = e.dataTransfer.files[0].name;
            fileInfo.classList.remove('d-none');
        }
    };

    // Handle Drop Zone for Extract PDF
    dropZoneExtract.onclick = () => extractInput.click();
    
    extractInput.onchange = (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('Vui l√≤ng ch·ªçn file PDF!');
                e.target.value = '';
                return;
            }
            extractFileName.innerText = file.name;
            extractFileInfo.classList.remove('d-none');
        }
    };

    dropZoneExtract.ondragover = (e) => { e.preventDefault(); dropZoneExtract.classList.add('active'); };
    dropZoneExtract.ondragleave = () => { dropZoneExtract.classList.remove('active'); };
    dropZoneExtract.ondrop = (e) => {
        e.preventDefault();
        dropZoneExtract.classList.remove('active');
        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('Vui l√≤ng ch·ªçn file PDF!');
                return;
            }
            extractInput.files = e.dataTransfer.files;
            extractFileName.innerText = file.name;
            extractFileInfo.classList.remove('d-none');
        }
    };

    // Handle Form Submissions
    async function handleConvert(formId, endpoint, fileExtension = null) {
        const form = document.getElementById(formId);
        form.onsubmit = async (e) => {
            e.preventDefault();
            loading.style.display = 'flex';
            
            try {
                const formData = new FormData(form);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // L·∫•y t√™n file chu·∫©n t·ª´ header
                    const disposition = response.headers.get('content-disposition');
                    let filename = fileExtension ? `converted.${fileExtension}` : 'converted.pdf';
                    if (disposition && disposition.indexOf('filename=') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) { 
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    
                    // Show success message for extraction
                    if (endpoint === '/extract-pdf') {
                        const summary = response.headers.get('X-Extraction-Summary');
                        if (summary) {
                            setTimeout(() => {
                                alert('‚úÖ Tr√≠ch xu·∫•t th√†nh c√¥ng!\n\n' + summary.replace(/,/g, '\n'));
                            }, 500);
                        }
                    }
                } else {
                    let errorMsg = 'Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi';
                    try {
                        const text = await response.text();
                        try {
                            const err = JSON.parse(text);
                            errorMsg = err.detail || errorMsg;
                        } catch (e) {
                            errorMsg = text || errorMsg;
                        }
                    } catch (e) {
                        errorMsg = 'L·ªói k·∫øt n·ªëi server';
                    }
                    alert('L·ªói: ' + errorMsg);
                }
            } catch (err) {
                alert('L·ªói k·∫øt n·ªëi server: ' + err.message);
            } finally {
                loading.style.display = 'none';
            }
        };
    }

    // Special handler for extraction with view/download options
    async function handleExtraction(mode) {
        const form = document.getElementById('extractForm');
        const fileInput = document.getElementById('extractInput');
        
        if (!fileInput.files.length) {
            alert('Vui l√≤ng ch·ªçn file PDF!');
            return;
        }
        
        // Get selected method
        const methodRadios = document.getElementsByName('extractMethod');
        let selectedMethod = 'docling';
        for (const radio of methodRadios) {
            if (radio.checked) {
                selectedMethod = radio.value;
                break;
            }
        }
        
        loading.style.display = 'flex';
        
        try {
            const formData = new FormData(form);
            formData.append('view_mode', mode);
            formData.append('method', selectedMethod);
            
            const response = await fetch('/extract-pdf', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                if (mode === 'view') {
                    // Parse JSON and redirect to view page
                    const result = await response.json();
                    if (result.success && result.view_url) {
                        window.location.href = result.view_url;
                        return;
                    }
                } else {
                    // Download ZIP file
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const disposition = response.headers.get('content-disposition');
                    let filename = 'extracted.zip';
                    if (disposition && disposition.indexOf('filename=') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) { 
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    
                    const summary = response.headers.get('X-Extraction-Summary');
                    if (summary) {
                        setTimeout(() => {
                            alert('‚úÖ Tr√≠ch xu·∫•t th√†nh c√¥ng!\n\n' + summary.replace(/,/g, '\n'));
                        }, 500);
                    }
                }
            } else {
                let errorMsg = 'Kh√¥ng th·ªÉ tr√≠ch xu·∫•t';
                try {
                    const text = await response.text();
                    try {
                        const err = JSON.parse(text);
                        errorMsg = err.detail || errorMsg;
                    } catch (e) {
                        errorMsg = text || errorMsg;
                    }
                } catch (e) {
                    errorMsg = 'L·ªói k·∫øt n·ªëi server';
                }
                alert('L·ªói: ' + errorMsg);
            }
        } catch (err) {
            alert('L·ªói k·∫øt n·ªëi server: ' + err.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    handleConvert('urlForm', '/convert-url');
    handleConvert('fileForm', '/convert-file');
    
    // Prevent form submit for extract form (use buttons instead)
    document.getElementById('extractForm').onsubmit = (e) => {
        e.preventDefault();
        return false;
    };
    
    // Setup extraction buttons
    document.getElementById('viewExtractBtn').onclick = () => handleExtraction('view');
    document.getElementById('downloadExtractBtn').onclick = () => handleExtraction('download');
</script>

</body>
</html>
