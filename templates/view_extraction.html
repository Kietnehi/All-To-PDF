<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả trích xuất PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header-section { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 30px 0; margin-bottom: 30px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .nav-tabs .nav-link { border-radius: 10px 10px 0 0; font-weight: 500; }
        .nav-tabs .nav-link.active { background-color: #007bff; color: white; border-color: #007bff; }
        .text-content { max-height: 600px; overflow-y: auto; padding: 20px; background: #fff; border-radius: 10px; }
        .table-preview { max-height: 400px; overflow: auto; }
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .image-item { border-radius: 10px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.3s; }
        .image-item:hover { transform: scale(1.05); }
        .image-item img { width: 100%; height: 200px; object-fit: cover; }
        .badge-custom { padding: 8px 15px; font-size: 0.9rem; font-weight: 500; }
        pre { background: #f6f8fa; border-radius: 8px; padding: 15px; }
        .summary-box { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .loading-spinner { display: none; text-align: center; padding: 30px; }
    </style>
</head>
<body>

<div class="header-section text-center">
    <div class="container">
        <h1 class="h3 mb-2"><i class="fas fa-file-pdf me-2"></i>Kết quả trích xuất PDF</h1>
        <p class="mb-0 small">ID: {{ extract_id }}</p>
    </div>
</div>

<div class="container mb-5">
    <!-- Action Buttons -->
    <div class="text-center mb-4">
        <a href="/" class="btn btn-outline-primary me-2"><i class="fas fa-home me-2"></i>Về trang chủ</a>
        <a href="/download-extraction-zip/{{ extract_id }}" class="btn btn-success"><i class="fas fa-download me-2"></i>Tải toàn bộ (ZIP)</a>
    </div>

    <!-- Summary -->
    <div class="summary-box">
        <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Thông tin</h5>
        <div class="row text-center">
            <div class="col-md-4 mb-2">
                <span class="badge-custom badge bg-success"><i class="fas fa-file-alt me-2"></i>Text: 2 files</span>
            </div>
            <div class="col-md-4 mb-2">
                <span class="badge-custom badge bg-warning text-dark"><i class="fas fa-table me-2"></i>Tables: {{ tables|length }}</span>
            </div>
            <div class="col-md-4 mb-2">
                <span class="badge-custom badge bg-info"><i class="fas fa-image me-2"></i>Images: {{ images|length }}</span>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-3" id="resultTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button" role="tab">
                <i class="fas fa-file-alt me-2"></i>Text
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tables-tab" data-bs-toggle="tab" data-bs-target="#tables" type="button" role="tab">
                <i class="fas fa-table me-2"></i>Tables ({{ tables|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" role="tab">
                <i class="fas fa-image me-2"></i>Images ({{ images|length }})
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="resultTabContent">
        <!-- Text Tab -->
        <div class="tab-pane fade show active" id="text" role="tabpanel">
            <div class="card p-4">
                <div class="mb-3">
                    <button class="btn btn-sm btn-primary me-2" onclick="loadText('md')">
                        <i class="fas fa-code me-1"></i>Markdown
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadText('txt')">
                        <i class="fas fa-align-left me-1"></i>Plain Text
                    </button>
                </div>
                <div class="loading-spinner" id="textLoading">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Đang tải...</p>
                </div>
                <div class="text-content" id="textContent">
                    <p class="text-muted text-center">Nhấn nút bên trên để xem nội dung</p>
                </div>
            </div>
        </div>

        <!-- Tables Tab -->
        <div class="tab-pane fade" id="tables" role="tabpanel">
            <div class="card p-4">
                {% if tables %}
                    <div class="list-group">
                        {% for table in tables %}
                        <a href="#" class="list-group-item list-group-item-action" onclick="loadTable('{{ table }}'); return false;">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <h6 class="mb-1">
                                    <i class="fas fa-table me-2 text-warning"></i>{{ table }}
                                    {% if table.endswith('.html') %}
                                    <span class="badge bg-info ms-2">HTML</span>
                                    {% endif %}
                                </h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="downloadTable('{{ table }}'); event.stopPropagation(); return false;">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <div class="loading-spinner" id="tableLoading">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Đang tải bảng...</p>
                        </div>
                        <div id="tablePreview"></div>
                    </div>
                {% else %}
                    <p class="text-center text-muted">Không tìm thấy bảng trong PDF này</p>
                {% endif %}
            </div>
        </div>

        <!-- Images Tab -->
        <div class="tab-pane fade" id="images" role="tabpanel">
            <div class="card p-4">
                {% if images %}
                    <div class="image-gallery">
                        {% for image in images %}
                        <div class="image-item" onclick="openImageModal('{{ image }}')">
                            <img src="/serve-image/{{ extract_id }}/{{ image }}" alt="{{ image }}" loading="lazy">
                            <div class="p-2 bg-light">
                                <small class="text-muted"><i class="fas fa-image me-1"></i>{{ image }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-center text-muted">Không tìm thấy hình ảnh trong PDF này</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" style="max-height: 80vh;">
            </div>
            <div class="modal-footer">
                <a id="downloadImageBtn" href="" download class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Tải ảnh
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
<script>
    const extractId = '{{ extract_id }}';
    
    // Load text content
    async function loadText(format) {
        const loading = document.getElementById('textLoading');
        const content = document.getElementById('textContent');
        
        loading.style.display = 'block';
        content.innerHTML = '';
        
        try {
            const response = await fetch(`/get-extracted-text/${extractId}?format=${format}`);
            const data = await response.json();
            
            if (format === 'md') {
                // Render markdown
                content.innerHTML = `<div class="markdown-body">${marked.parse(data.content)}</div>`;
            } else {
                // Show plain text
                content.innerHTML = `<pre style="white-space: pre-wrap;">${escapeHtml(data.content)}</pre>`;
            }
        } catch (err) {
            content.innerHTML = `<div class="alert alert-danger">Lỗi tải nội dung: ${err.message}</div>`;
        } finally {
            loading.style.display = 'none';
        }
    }
    
    // Load table preview
    async function loadTable(filename) {
        const loading = document.getElementById('tableLoading');
        const preview = document.getElementById('tablePreview');
        
        loading.style.display = 'block';
        preview.innerHTML = '';
        
        try {
            // Check if HTML or CSV
            if (filename.endsWith('.html')) {
                // Load and display HTML table
                const response = await fetch(`/serve-table/${extractId}/${filename}`);
                const htmlContent = await response.text();
                
                preview.innerHTML = `
                    <div class="table-preview">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Bảng HTML (từ Unstructured)
                        </div>
                        ${htmlContent}
                    </div>
                `;
            } else {
                // Load and parse CSV
                const response = await fetch(`/serve-table/${extractId}/${filename}`);
                const text = await response.text();
                
                // Parse CSV
                const rows = text.trim().split('\n').map(row => {
                    // Simple CSV parser
                    return row.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                });
                
                if (rows.length > 0) {
                    let html = '<div class="table-preview"><table class="table table-striped table-bordered table-hover">';
                    
                    // Header
                    html += '<thead class="table-dark"><tr>';
                    rows[0].forEach(cell => {
                        html += `<th>${escapeHtml(cell)}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    // Body (limit to 100 rows)
                    for (let i = 1; i < Math.min(rows.length, 100); i++) {
                        html += '<tr>';
                        rows[i].forEach(cell => {
                            html += `<td>${escapeHtml(cell)}</td>`;
                        });
                        html += '</tr>';
                    }
                    
                    html += '</tbody></table></div>';
                    
                    if (rows.length > 100) {
                        html += '<p class="text-muted text-center mt-2"><small>Chỉ hiển thị 100 dòng đầu. Tải file CSV để xem toàn bộ.</small></p>';
                    }
                    
                    preview.innerHTML = html;
                }
            }
        } catch (err) {
            preview.innerHTML = `<div class="alert alert-danger">Lỗi tải bảng: ${err.message}</div>`;
        } finally {
            loading.style.display = 'none';
        }
    }
    
    // Download table
    function downloadTable(filename) {
        window.location.href = `/serve-table/${extractId}/${filename}`;
    }
    
    // Open image modal
    function openImageModal(filename) {
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        const img = document.getElementById('modalImage');
        const downloadBtn = document.getElementById('downloadImageBtn');
        const label = document.getElementById('imageModalLabel');
        
        const imageUrl = `/serve-image/${extractId}/${filename}`;
        img.src = imageUrl;
        downloadBtn.href = imageUrl;
        downloadBtn.download = filename;
        label.textContent = filename;
        
        modal.show();
    }
    
    // Utility function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Auto-load markdown on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadText('md');
    });
</script>

</body>
</html>
